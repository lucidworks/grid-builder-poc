import{a as t,f as n}from"./p-BS4nUT4S.js";class e{constructor(){this.canvases=new Map}getCanvas(t){if(this.canvases.has(t)){return this.canvases.get(t)}const n=document.getElementById(t);if(n){this.canvases.set(t,n)}return n}invalidate(t){this.canvases.delete(t)}clear(){this.canvases.clear()}}const s=20;const o=.02;const i=10;const r=50;const c=new Map;function u(t){if(t){const n=`${t}-`;for(const t of c.keys()){if(t.startsWith(n)){c.delete(t)}}}else{c.clear()}}function a(t,n,e){var s,u;const a=(e===null||e===void 0?void 0:e.instanceId)?`${e.instanceId}-${t}-h`:`${t}-h`;const l=(e===null||e===void 0?void 0:e.gridSizePercent)?e.gridSizePercent/100:o;const f=n*l;const d=(s=e===null||e===void 0?void 0:e.minGridSize)!==null&&s!==void 0?s:i;const h=(u=e===null||e===void 0?void 0:e.maxGridSize)!==null&&u!==void 0?u:r;const m=Math.max(d,Math.min(h,f));c.set(a,m)}function l(t,n,s=false,u){var a,l;const f=(n===null||n===void 0?void 0:n.instanceId)?`${n.instanceId}-${t}-h`:`${t}-h`;if(!s&&c.has(f)){return c.get(f)}const d=u||new e;const h=d.getCanvas(t);if(!h){console.warn(`Canvas container not found: ${t}`);return 0}const m=(n===null||n===void 0?void 0:n.gridSizePercent)?n.gridSizePercent/100:o;const p=h.clientWidth*m;const v=(a=n===null||n===void 0?void 0:n.minGridSize)!==null&&a!==void 0?a:i;const b=(l=n===null||n===void 0?void 0:n.maxGridSize)!==null&&l!==void 0?l:r;const I=Math.max(v,Math.min(b,p));if(h.clientWidth>100){c.set(f,I)}return I}function f(t){var n;return(n=t===null||t===void 0?void 0:t.verticalGridSize)!==null&&n!==void 0?n:s}function d(t,n,e){const s=l(n,e);return Math.round(t*s)}function h(t,n){return t*f(n)}function m(t,n,e){const s=l(n,e);if(s===0){return 0}return Math.round(t/s)}function p(t,n){return Math.round(t/f(n))}var v=Object.freeze({__proto__:null,clearGridSizeCache:u,getGridSizeHorizontal:l,getGridSizeVertical:f,gridToPixelsX:d,gridToPixelsY:h,pixelsToGridX:m,pixelsToGridY:p,setGridSizeCache:a});const b=(t,n,e)=>{const s=t.get(n);if(!s){t.set(n,[e])}else if(!s.includes(e)){s.push(e)}};const I=(t,n)=>{let e;return(...s)=>{if(e){clearTimeout(e)}e=setTimeout((()=>{e=0;t(...s)}),n)}};const g=t=>!("isConnected"in t)||t.isConnected;const $=I((t=>{for(let n of t.keys()){t.set(n,t.get(n).filter(g))}}),2e3);const y=()=>{if(typeof t!=="function"){return{}}const e=new Map;return{dispose:()=>e.clear(),get:n=>{const s=t();if(s){b(e,n,s)}},set:t=>{const s=e.get(t);if(s){e.set(t,s.filter(n))}$(e)},reset:()=>{e.forEach((t=>t.forEach(n)));$(e)}}};const w=t=>typeof t==="function"?t():t;const j=(t,n=(t,n)=>t!==n)=>{const e=w(t);let s=new Map(Object.entries(e??{}));const o={dispose:[],get:[],set:[],reset:[]};const i=new Map;const r=()=>{s=new Map(Object.entries(w(t)??{}));o.reset.forEach((t=>t()))};const c=()=>{o.dispose.forEach((t=>t()));r()};const u=t=>{o.get.forEach((n=>n(t)));return s.get(t)};const a=(t,e)=>{const i=s.get(t);if(n(e,i,t)){s.set(t,e);o.set.forEach((n=>n(t,e,i)))}};const l=typeof Proxy==="undefined"?{}:new Proxy(e,{get(t,n){return u(n)},ownKeys(t){return Array.from(s.keys())},getOwnPropertyDescriptor(){return{enumerable:true,configurable:true}},has(t,n){return s.has(n)},set(t,n,e){a(n,e);return true}});const f=(t,n)=>{o[t].push(n);return()=>{x(o[t],n)}};const d=(n,e)=>{const s=(t,s)=>{if(t===n){e(s)}};const o=()=>e(w(t)[n]);const r=f("set",s);const c=f("reset",o);i.set(e,{setHandler:s,resetHandler:o,propName:n});return()=>{r();c();i.delete(e)}};const h=(...t)=>{const n=t.reduce(((t,n)=>{if(n.set){t.push(f("set",n.set))}if(n.get){t.push(f("get",n.get))}if(n.reset){t.push(f("reset",n.reset))}if(n.dispose){t.push(f("dispose",n.dispose))}return t}),[]);return()=>n.forEach((t=>t()))};const m=t=>{const n=s.get(t);o.set.forEach((e=>e(t,n,n)))};const p=(t,n)=>{const e=i.get(n);if(e&&e.propName===t){x(o.set,e.setHandler);x(o.reset,e.resetHandler);i.delete(n)}};return{state:l,get:u,set:a,on:f,onChange:d,use:h,dispose:c,reset:r,forceUpdate:m,removeListener:p}};const x=(t,n)=>{const e=t.indexOf(n);if(e>=0){t[e]=t[t.length-1];t.length--}};const O=(t,n)=>{const e=j(t,n);e.use(y());return e};function C(){if(typeof process!=="undefined"&&process.env&&"production"==="development");if(typeof process!=="undefined"&&process.env&&"production"==="test");return false}const M={log(...t){if(C()){console.log(...t)}},warn(...t){if(C()){console.warn(...t)}},error(...t){if(C()){console.error(...t)}},group(t,n){if(C()){console.group(t);n();console.groupEnd()}},isEnabled(){return C()}};function T(t){return{log(...n){M.log(`[${t}]`,...n)},warn(...n){M.warn(`[${t}]`,...n)},error(...n){M.error(`[${t}]`,...n)},group(n,e){M.group(`[${t}] ${n}`,e)},isEnabled(){return M.isEnabled()}}}const N={x:{min:0},y:{min:0},width:{min:1,max:50},height:{min:1,max:100}};function S(t,n){const e=[];if(!t){e.push(`${n} layout is missing or undefined`);return{valid:false,errors:e}}const s=["x","y","width","height"];for(const o of s){if(typeof t[o]!=="number"||!Number.isFinite(t[o])){e.push(`${n} layout.${o} must be a finite number, got: ${t[o]}`)}}if(Number.isFinite(t.x)&&t.x<N.x.min){e.push(`${n} layout.x must be >= ${N.x.min}, got: ${t.x}`)}if(Number.isFinite(t.y)&&t.y<N.y.min){e.push(`${n} layout.y must be >= ${N.y.min}, got: ${t.y}`)}if(Number.isFinite(t.width)&&(t.width<N.width.min||t.width>N.width.max)){e.push(`${n} layout.width must be between ${N.width.min}-${N.width.max}, got: ${t.width}`)}if(Number.isFinite(t.height)&&(t.height<N.height.min||t.height>N.height.max)){e.push(`${n} layout.height must be between ${N.height.min}-${N.height.max}, got: ${t.height}`)}return{valid:e.length===0,errors:e}}function Z(t){const n=[];if(!t){n.push("Item is null or undefined");return{valid:false,errors:n}}if(typeof t.id!=="string"||t.id.trim()===""){n.push(`Item.id must be a non-empty string, got: ${t.id}`)}if(typeof t.canvasId!=="string"||t.canvasId.trim()===""){n.push(`Item.canvasId must be a non-empty string, got: ${t.canvasId}`)}if(typeof t.type!=="string"||t.type.trim()===""){n.push(`Item.type must be a non-empty string, got: ${t.type}`)}if(typeof t.zIndex!=="number"||!Number.isFinite(t.zIndex)){n.push(`Item.zIndex must be a finite number, got: ${t.zIndex} (type: ${typeof t.zIndex})`)}if(!t.layouts||typeof t.layouts!=="object"){n.push("Item.layouts must be an object");return{valid:false,errors:n}}const e=S(t.layouts.desktop,"desktop");if(!e.valid){n.push(...e.errors)}if(t.layouts.mobile){const e=S(t.layouts.mobile,"mobile");if(!e.valid){n.push(...e.errors)}}return{valid:n.length===0,errors:n}}function k(t){const n=[];if(!t||typeof t!=="object"){n.push("Updates must be an object");return{valid:false,errors:n}}if(t.layouts){if(typeof t.layouts!=="object"){n.push("Updates.layouts must be an object")}else{if(t.layouts.desktop){const e=S(t.layouts.desktop,"desktop");if(!e.valid){n.push(...e.errors)}}if(t.layouts.mobile){const e=S(t.layouts.mobile,"mobile");if(!e.valid){n.push(...e.errors)}}}}if("zIndex"in t&&(typeof t.zIndex!=="number"||!Number.isFinite(t.zIndex))){n.push(`Updates.zIndex must be a finite number, got: ${t.zIndex}`)}if("config"in t&&typeof t.config!=="object"){n.push(`Updates.config must be an object, got: ${typeof t.config}`)}return{valid:n.length===0,errors:n}}const z={canvases:{},selectedItemId:null,selectedCanvasId:null,activeCanvasId:null,currentViewport:"desktop",showGrid:true};const B=T("state-manager");class G{constructor(t){this.itemIdCounter=0;const n=Object.assign(Object.assign({},z),t);const{state:e,onChange:s,dispose:o}=O(n);this.state=e;this.onChange=s;this.dispose=o;this.initialState=JSON.parse(JSON.stringify(n))}reset(){this.itemIdCounter=0;this.state.canvases=JSON.parse(JSON.stringify(this.initialState.canvases));this.state.selectedItemId=this.initialState.selectedItemId;this.state.selectedCanvasId=this.initialState.selectedCanvasId;this.state.activeCanvasId=this.initialState.activeCanvasId;this.state.currentViewport=this.initialState.currentViewport;this.state.showGrid=this.initialState.showGrid}addItemToCanvas(t,n){const e=this.state.canvases[t];if(!e){return}const s=Z(n);if(!s.valid){B.warn("⚠️ [addItemToCanvas] with validation issues:",{itemId:n.id,canvasId:t,errors:s.errors})}e.items.push(n);this.state.canvases=Object.assign({},this.state.canvases)}removeItemFromCanvas(t,n){const e=this.state.canvases[t];if(!e){return}e.items=e.items.filter((t=>t.id!==n));this.state.canvases=Object.assign({},this.state.canvases)}updateItem(t,n,e){const s=this.state.canvases[t];if(!s){return}const o=s.items.find((t=>t.id===n));if(!o){return}const i=k(e);if(!i.valid){B.warn("⚠️ [updateItem] with validation issues:",{itemId:n,canvasId:t,updates:e,errors:i.errors})}Object.assign(o,e);this.state.canvases=Object.assign({},this.state.canvases)}getItem(t,n){const e=this.state.canvases[t];if(!e){return null}return e.items.find((t=>t.id===n))||null}moveItemToCanvas(t,n,e){const s=this.state.canvases[t];const o=this.state.canvases[n];if(!s||!o){return}const i=s.items.find((t=>t.id===e));if(!i){return}const r=Z(i);if(!r.valid){B.warn("⚠️ [moveItemToCanvas] with validation issues:",{itemId:e,fromCanvasId:t,toCanvasId:n,errors:r.errors})}s.items=s.items.filter((t=>t.id!==e));i.canvasId=n;o.items.push(i);this.state.canvases=Object.assign({},this.state.canvases)}generateItemId(){return`item-${++this.itemIdCounter}`}setItemZIndex(t,n,e){const s=this.state.canvases[t];if(!s){return null}const o=s.items.find((t=>t.id===n));if(!o){return null}const i=o.zIndex;o.zIndex=e;if(e>=s.zIndexCounter){s.zIndexCounter=e+1}this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:i,newZIndex:e}}moveItemForward(t,n){const e=this.state.canvases[t];if(!e){return null}const s=e.items.find((t=>t.id===n));if(!s){return null}const o=[...e.items].sort(((t,n)=>t.zIndex-n.zIndex));const i=o.findIndex((t=>t.id===n));if(i===o.length-1){return null}const r=o[i+1];const c=s.zIndex;const u=r.zIndex;s.zIndex=u;r.zIndex=c;this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:c,newZIndex:u}}moveItemBackward(t,n){const e=this.state.canvases[t];if(!e){return null}const s=e.items.find((t=>t.id===n));if(!s){return null}const o=[...e.items].sort(((t,n)=>t.zIndex-n.zIndex));const i=o.findIndex((t=>t.id===n));if(i===0){return null}const r=o[i-1];const c=s.zIndex;const u=r.zIndex;s.zIndex=u;r.zIndex=c;this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:c,newZIndex:u}}bringItemToFront(t,n){const e=this.state.canvases[t];if(!e){return null}const s=e.items.find((t=>t.id===n));if(!s){return null}const o=s.zIndex;const i=Math.max(...e.items.map((t=>t.zIndex)));if(o===i){return null}const r=e.zIndexCounter++;s.zIndex=r;this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:o,newZIndex:r}}sendItemToBack(t,n){const e=this.state.canvases[t];if(!e){return null}const s=e.items.find((t=>t.id===n));if(!s){return null}const o=s.zIndex;const i=Math.min(...e.items.map((t=>t.zIndex)));if(o===i){return null}const r=i-1;s.zIndex=r;this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:o,newZIndex:r}}selectItem(t,n){this.state.selectedItemId=t;this.state.selectedCanvasId=n}deselectItem(){this.state.selectedItemId=null;this.state.selectedCanvasId=null}setActiveCanvas(t){this.state.activeCanvasId=t}clearActiveCanvas(){this.state.activeCanvasId=null}addItemsBatch(t){const n=[];const e=Object.assign({},this.state.canvases);for(const s of t){const t=this.generateItemId();const o=s.canvasId;const i=e[o];if(!i){console.warn(`Canvas ${o} not found, skipping item`);continue}const r={id:t,canvasId:o,type:s.type||"unknown",name:s.name||"Unnamed",layouts:s.layouts||{desktop:{x:0,y:0,width:20,height:10},mobile:{x:null,y:null,width:null,height:null,customized:false}},zIndex:i.zIndexCounter++,config:s.config||{}};const c=Z(r);if(!c.valid){B.warn("⚠️ [addItemsBatch] with validation issues:",{itemId:t,canvasId:o,errors:c.errors})}i.items.push(r);n.push(t)}this.state.canvases=e;return n}deleteItemsBatch(t){const n=new Set(t);const e=Object.assign({},this.state.canvases);for(const t in e){e[t]=Object.assign(Object.assign({},e[t]),{items:e[t].items.filter((t=>!n.has(t.id)))})}this.state.canvases=e}updateItemsBatch(t){const n=Object.assign({},this.state.canvases);for(const{itemId:e,canvasId:s,updates:o}of t){const t=n[s];if(!t){console.warn(`Canvas ${s} not found, skipping item ${e}`);continue}const i=t.items.find((t=>t.id===e));if(!i){console.warn(`Item ${e} not found in canvas ${s}`);continue}Object.assign(i,o)}this.state.canvases=n}}const U=new G;const P=U.state;const J=()=>U.generateItemId();const _=(t,n)=>U.selectItem(t,n);const A=t=>U.setActiveCanvas(t);export{e as D,G as S,h as a,f as b,u as c,a as d,d as e,T as f,P as g,_ as h,l as i,p as j,O as k,J as l,v as m,m as p,A as s};
//# sourceMappingURL=p-DR95X3EV.js.map