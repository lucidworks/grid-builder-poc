{"version":3,"file":"event-manager.js","sourceRoot":"","sources":["../../src/services/event-manager.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Event Manager Service\n * ======================\n *\n * Simple event emitter for grid builder events. Provides on/off/emit pattern\n * for plugins and API consumers to subscribe to grid builder actions.\n *\n * ## Design Pattern\n *\n * **EventEmitter pattern**:\n * - on(event, callback) - Subscribe to event\n * - off(event, callback) - Unsubscribe from event\n * - emit(event, data) - Fire event to all subscribers\n *\n * **Callback storage**: Map<eventName, Set<callback>>\n * - O(1) subscription/unsubscription\n * - Set prevents duplicate callbacks\n * - Easy cleanup (delete entire event Set)\n *\n * ## Usage Example\n *\n * ```typescript\n * import { eventManager } from './event-manager';\n *\n * // Subscribe\n * const callback = (data) => console.log('Item added:', data);\n * eventManager.on('componentAdded', callback);\n *\n * // Fire event\n * eventManager.emit('componentAdded', { itemId: '123', canvasId: 'canvas1' });\n *\n * // Unsubscribe\n * eventManager.off('componentAdded', callback);\n * ```\n *\n * ## Memory Management\n *\n * **Plugin cleanup**:\n * - Plugins MUST unsubscribe in destroy()\n * - Use same callback reference for on/off\n * - Prevents memory leaks\n *\n * **Internal cleanup**:\n * - Empty event Sets auto-deleted\n * - No memory retention for unused events\n *\n * @module event-manager\n */\n\nimport { EventCallback } from '../types/api';\n\n/**\n * EventManager Class\n * ==================\n *\n * Simple event emitter for grid builder events.\n *\n * **Storage structure**:\n * ```typescript\n * Map {\n *   'componentAdded' => Set([callback1, callback2, ...]),\n *   'componentDeleted' => Set([callback3, callback4, ...]),\n *   ...\n * }\n * ```\n *\n * **Why Set instead of Array**:\n * - O(1) lookup for has/delete\n * - Prevents duplicate callbacks\n * - Better performance for large subscriber counts\n */\nexport class EventManager {\n  /**\n   * Event listeners storage\n   *\n   * **Key**: Event name (e.g., 'componentAdded')\n   * **Value**: Set of callback functions\n   *\n   * **Why Map instead of plain object**:\n   * - Better type safety\n   * - No prototype pollution\n   * - Better performance for dynamic keys\n   */\n  private listeners: Map<string, Set<EventCallback>> = new Map();\n\n  /**\n   * Debounce timers for events\n   *\n   * **Key**: Event name\n   * **Value**: setTimeout timer ID\n   *\n   * **Purpose**: Store timers for debounced events\n   */\n  private debounceTimers: Map<string, NodeJS.Timeout> = new Map();\n\n  /**\n   * Debounce delay in milliseconds\n   *\n   * **Default**: 300ms\n   * **Configured by**: grid-builder via setDebounceDelay()\n   */\n  private debounceDelay: number = 300;\n\n  /**\n   * Events that should be debounced\n   *\n   * **Events**: componentDragged, componentResized, stateChanged\n   * **Reason**: Fire on every pixel during drag/resize\n   */\n  private debouncedEvents: Set<string> = new Set([\n    'componentDragged',\n    'componentResized',\n    'stateChanged',\n  ]);\n\n  /**\n   * Subscribe to event\n   *\n   * **Idempotent**: Calling multiple times with same callback does nothing\n   * **Thread-safe**: Uses Set which handles concurrent additions\n   *\n   * @param eventName - Event to subscribe to\n   * @param callback - Function called when event fires\n   *\n   * @example\n   * ```typescript\n   * eventManager.on('componentAdded', (data) => {\n   *   console.log(`Added ${data.item.type} to ${data.canvasId}`);\n   * });\n   * ```\n   */\n  on<T = any>(eventName: string, callback: EventCallback<T>): void {\n    if (!this.listeners.has(eventName)) {\n      this.listeners.set(eventName, new Set());\n    }\n    this.listeners.get(eventName)!.add(callback as EventCallback);\n  }\n\n  /**\n   * Unsubscribe from event\n   *\n   * **Requirements**:\n   * - Must pass EXACT same callback reference used in on()\n   * - Callback stored as property or bound method\n   *\n   * **Cleanup**: If event has no more listeners, delete the Set\n   *\n   * @param eventName - Event to unsubscribe from\n   * @param callback - Exact callback reference used in on()\n   *\n   * @example\n   * ```typescript\n   * // âœ… Correct pattern\n   * class MyPlugin {\n   *   private handleAdd = (data) => console.log(data);\n   *\n   *   init(api) {\n   *     eventManager.on('componentAdded', this.handleAdd);\n   *   }\n   *\n   *   destroy() {\n   *     eventManager.off('componentAdded', this.handleAdd);\n   *   }\n   * }\n   * ```\n   */\n  off<T = any>(eventName: string, callback: EventCallback<T>): void {\n    const callbacks = this.listeners.get(eventName);\n    if (callbacks) {\n      callbacks.delete(callback as EventCallback);\n\n      // Cleanup empty event listeners\n      if (callbacks.size === 0) {\n        this.listeners.delete(eventName);\n      }\n    }\n  }\n\n  /**\n   * Fire event to all subscribers\n   *\n   * **Debouncing**: Some events are automatically debounced:\n   * - componentDragged (fires on every pixel)\n   * - componentResized (fires on every pixel)\n   * - stateChanged (fires on every state update)\n   *\n   * **Immediate events** (not debounced):\n   * - componentSelected, componentDeleted, componentAdded, etc.\n   *\n   * **Execution order**: Subscribers called in insertion order\n   * **Error handling**: One callback error doesn't prevent others\n   *\n   * **Performance**: O(n) where n = number of callbacks for this event\n   *\n   * @param eventName - Event to fire\n   * @param data - Data to pass to callbacks\n   *\n   * @example\n   * ```typescript\n   * // Internal usage (in state-manager.ts)\n   * eventManager.emit('componentAdded', {\n   *   item: newItem,\n   *   canvasId: 'canvas1',\n   *   timestamp: Date.now()\n   * });\n   * ```\n   */\n  emit<T = any>(eventName: string, data: T): void {\n    // Check if this event should be debounced\n    if (this.debouncedEvents.has(eventName)) {\n      this.emitDebounced(eventName, data);\n    } else {\n      this.emitImmediate(eventName, data);\n    }\n  }\n\n  /**\n   * Fire event immediately (no debouncing)\n   *\n   * **Private method**: Called by emit()\n   *\n   * @param eventName - Event to fire\n   * @param data - Data to pass to callbacks\n   */\n  private emitImmediate<T = any>(eventName: string, data: T): void {\n    const callbacks = this.listeners.get(eventName);\n    if (callbacks) {\n      callbacks.forEach((callback) => {\n        try {\n          callback(data);\n        } catch (error) {\n          console.error(`Error in event callback for \"${eventName}\":`, error);\n        }\n      });\n    }\n  }\n\n  /**\n   * Fire event with debouncing\n   *\n   * **How it works**:\n   * 1. Clear any existing timer for this event\n   * 2. Set new timer with debounceDelay\n   * 3. When timer fires, call emitImmediate()\n   * 4. If emit() called again before timer fires, restart timer\n   *\n   * **Result**: Event only fires once after activity stops\n   *\n   * **Private method**: Called by emit()\n   *\n   * @param eventName - Event to fire\n   * @param data - Data to pass to callbacks\n   */\n  private emitDebounced<T = any>(eventName: string, data: T): void {\n    // Clear existing timer for this event\n    const existingTimer = this.debounceTimers.get(eventName);\n    if (existingTimer) {\n      clearTimeout(existingTimer);\n    }\n\n    // Set new timer\n    const timer = setTimeout(() => {\n      this.emitImmediate(eventName, data);\n      this.debounceTimers.delete(eventName);\n    }, this.debounceDelay);\n\n    this.debounceTimers.set(eventName, timer);\n  }\n\n  /**\n   * Set debounce delay for all debounced events\n   *\n   * **Configurable**: Called by grid-builder with config.eventDebounceDelay\n   *\n   * @param delay - Delay in milliseconds\n   *\n   * @example\n   * ```typescript\n   * // In grid-builder componentDidLoad\n   * eventManager.setDebounceDelay(config?.eventDebounceDelay || 300);\n   * ```\n   */\n  setDebounceDelay(delay: number): void {\n    this.debounceDelay = delay;\n  }\n\n  /**\n   * Get current debounce delay\n   *\n   * **Use case**: Debugging, testing\n   *\n   * @returns Debounce delay in milliseconds\n   */\n  getDebounceDelay(): number {\n    return this.debounceDelay;\n  }\n\n  /**\n   * Remove all listeners for specific event\n   *\n   * **Use case**: Cleanup during component unmount\n   *\n   * @param eventName - Event to remove all listeners from\n   *\n   * @example\n   * ```typescript\n   * // Clear all componentAdded listeners\n   * eventManager.removeAllListeners('componentAdded');\n   * ```\n   */\n  removeAllListeners(eventName?: string): void {\n    if (eventName) {\n      this.listeners.delete(eventName);\n    } else {\n      this.listeners.clear();\n    }\n  }\n\n  /**\n   * Get listener count for debugging\n   *\n   * **Use case**: Check for memory leaks (too many listeners)\n   *\n   * @param eventName - Event to count listeners for\n   * @returns Number of listeners or 0 if event not registered\n   *\n   * @example\n   * ```typescript\n   * const count = eventManager.listenerCount('componentAdded');\n   * console.log(`${count} listeners for componentAdded`);\n   * ```\n   */\n  listenerCount(eventName: string): number {\n    return this.listeners.get(eventName)?.size || 0;\n  }\n}\n\n/**\n * Global event manager instance\n *\n * **Singleton pattern**: One instance shared across entire library\n * **Why singleton**: Ensures all components/plugins use same event bus\n */\nexport const eventManager = new EventManager();\n"]}