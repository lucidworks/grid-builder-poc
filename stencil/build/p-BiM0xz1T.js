import{a as t,f as e}from"./p-CR9rAByj.js";class s{constructor(){this.canvases=new Map}getCanvas(t){if(this.canvases.has(t)){return this.canvases.get(t)}const e=document.getElementById(t);if(e){this.canvases.set(t,e)}return e}invalidate(t){this.canvases.delete(t)}clear(){this.canvases.clear()}}const n=20;const i=.02;const o=10;const r=50;const c=new Map;function a(t){if(t){const e=`${t}-`;for(const t of c.keys()){if(t.startsWith(e)){c.delete(t)}}}else{c.clear()}}function u(t,e,s){var n,a;const u=(s===null||s===void 0?void 0:s.instanceId)?`${s.instanceId}-${t}-h`:`${t}-h`;const d=(s===null||s===void 0?void 0:s.gridSizePercent)?s.gridSizePercent/100:i;const h=e*d;const l=(n=s===null||s===void 0?void 0:s.minGridSize)!==null&&n!==void 0?n:o;const f=(a=s===null||s===void 0?void 0:s.maxGridSize)!==null&&a!==void 0?a:r;const m=Math.max(l,Math.min(f,h));c.set(u,m)}function d(t,e,n=false,a){var u,d;const h=(e===null||e===void 0?void 0:e.instanceId)?`${e.instanceId}-${t}-h`:`${t}-h`;if(!n&&c.has(h)){return c.get(h)}const l=a||new s;const f=l.getCanvas(t);if(!f){console.warn(`Canvas container not found: ${t}`);return 0}const m=(e===null||e===void 0?void 0:e.gridSizePercent)?e.gridSizePercent/100:i;const p=f.clientWidth*m;const v=(u=e===null||e===void 0?void 0:e.minGridSize)!==null&&u!==void 0?u:o;const I=(d=e===null||e===void 0?void 0:e.maxGridSize)!==null&&d!==void 0?d:r;const g=Math.max(v,Math.min(I,p));if(f.clientWidth>100){c.set(h,g)}return g}function h(t){var e;return(e=t===null||t===void 0?void 0:t.verticalGridSize)!==null&&e!==void 0?e:n}function l(t,e,s){const n=d(e,s);return Math.round(t*n)}function f(t,e){return t*h(e)}function m(t,e,s){const n=d(e,s);if(n===0){return 0}return Math.round(t/n)}function p(t,e){return Math.round(t/h(e))}var v=Object.freeze({__proto__:null,clearGridSizeCache:a,getGridSizeHorizontal:d,getGridSizeVertical:h,gridToPixelsX:l,gridToPixelsY:f,pixelsToGridX:m,pixelsToGridY:p,setGridSizeCache:u});const I=(t,e,s)=>{const n=t.get(e);if(!n){t.set(e,[s])}else if(!n.includes(s)){n.push(s)}};const g=(t,e)=>{let s;return(...n)=>{if(s){clearTimeout(s)}s=setTimeout((()=>{s=0;t(...n)}),e)}};const b=t=>!("isConnected"in t)||t.isConnected;const $=g((t=>{for(let e of t.keys()){t.set(e,t.get(e).filter(b))}}),2e3);const y=()=>{if(typeof t!=="function"){return{}}const s=new Map;return{dispose:()=>s.clear(),get:e=>{const n=t();if(n){I(s,e,n)}},set:t=>{const n=s.get(t);if(n){s.set(t,n.filter(e))}$(s)},reset:()=>{s.forEach((t=>t.forEach(e)));$(s)}}};const w=t=>typeof t==="function"?t():t;const C=(t,e=(t,e)=>t!==e)=>{const s=w(t);let n=new Map(Object.entries(s??{}));const i={dispose:[],get:[],set:[],reset:[]};const o=new Map;const r=()=>{n=new Map(Object.entries(w(t)??{}));i.reset.forEach((t=>t()))};const c=()=>{i.dispose.forEach((t=>t()));r()};const a=t=>{i.get.forEach((e=>e(t)));return n.get(t)};const u=(t,s)=>{const o=n.get(t);if(e(s,o,t)){n.set(t,s);i.set.forEach((e=>e(t,s,o)))}};const d=typeof Proxy==="undefined"?{}:new Proxy(s,{get(t,e){return a(e)},ownKeys(t){return Array.from(n.keys())},getOwnPropertyDescriptor(){return{enumerable:true,configurable:true}},has(t,e){return n.has(e)},set(t,e,s){u(e,s);return true}});const h=(t,e)=>{i[t].push(e);return()=>{x(i[t],e)}};const l=(e,s)=>{const n=(t,n)=>{if(t===e){s(n)}};const i=()=>s(w(t)[e]);const r=h("set",n);const c=h("reset",i);o.set(s,{setHandler:n,resetHandler:i,propName:e});return()=>{r();c();o.delete(s)}};const f=(...t)=>{const e=t.reduce(((t,e)=>{if(e.set){t.push(h("set",e.set))}if(e.get){t.push(h("get",e.get))}if(e.reset){t.push(h("reset",e.reset))}if(e.dispose){t.push(h("dispose",e.dispose))}return t}),[]);return()=>e.forEach((t=>t()))};const m=t=>{const e=n.get(t);i.set.forEach((s=>s(t,e,e)))};const p=(t,e)=>{const s=o.get(e);if(s&&s.propName===t){x(i.set,s.setHandler);x(i.reset,s.resetHandler);o.delete(e)}};return{state:d,get:a,set:u,on:h,onChange:l,use:f,dispose:c,reset:r,forceUpdate:m,removeListener:p}};const x=(t,e)=>{const s=t.indexOf(e);if(s>=0){t[s]=t[t.length-1];t.length--}};const j=(t,e)=>{const s=C(t,e);s.use(y());return s};function O(){if(typeof process!=="undefined"&&process.env&&"production"==="development");if(typeof process!=="undefined"&&process.env&&"production"==="test");return false}const S={log(...t){if(O()){console.log(...t)}},warn(...t){if(O()){console.warn(...t)}},error(...t){if(O()){console.error(...t)}},group(t,e){if(O()){console.group(t);e();console.groupEnd()}},isEnabled(){return O()}};function k(t){return{log(...e){S.log(`[${t}]`,...e)},warn(...e){S.warn(`[${t}]`,...e)},error(...e){S.error(`[${t}]`,...e)},group(e,s){S.group(`[${t}] ${e}`,s)},isEnabled(){return S.isEnabled()}}}const M={x:{min:0},y:{min:0},width:{min:1,max:50},height:{min:1,max:100}};function z(t,e){const s=[];if(!t){s.push(`${e} layout is missing or undefined`);return{valid:false,errors:s}}const n=["x","y","width","height"];for(const i of n){if(typeof t[i]!=="number"||!Number.isFinite(t[i])){s.push(`${e} layout.${i} must be a finite number, got: ${t[i]}`)}}if(Number.isFinite(t.x)&&t.x<M.x.min){s.push(`${e} layout.x must be >= ${M.x.min}, got: ${t.x}`)}if(Number.isFinite(t.y)&&t.y<M.y.min){s.push(`${e} layout.y must be >= ${M.y.min}, got: ${t.y}`)}if(Number.isFinite(t.width)&&(t.width<M.width.min||t.width>M.width.max)){s.push(`${e} layout.width must be between ${M.width.min}-${M.width.max}, got: ${t.width}`)}if(Number.isFinite(t.height)&&(t.height<M.height.min||t.height>M.height.max)){s.push(`${e} layout.height must be between ${M.height.min}-${M.height.max}, got: ${t.height}`)}return{valid:s.length===0,errors:s}}function N(t){const e=[];if(!t){e.push("Item is null or undefined");return{valid:false,errors:e}}if(typeof t.id!=="string"||t.id.trim()===""){e.push(`Item.id must be a non-empty string, got: ${t.id}`)}if(typeof t.canvasId!=="string"||t.canvasId.trim()===""){e.push(`Item.canvasId must be a non-empty string, got: ${t.canvasId}`)}if(typeof t.type!=="string"||t.type.trim()===""){e.push(`Item.type must be a non-empty string, got: ${t.type}`)}if(typeof t.zIndex!=="number"||!Number.isFinite(t.zIndex)){e.push(`Item.zIndex must be a finite number, got: ${t.zIndex} (type: ${typeof t.zIndex})`)}if(!t.layouts||typeof t.layouts!=="object"){e.push("Item.layouts must be an object");return{valid:false,errors:e}}const s=z(t.layouts.desktop,"desktop");if(!s.valid){e.push(...s.errors)}if(t.layouts.mobile){const s=z(t.layouts.mobile,"mobile");if(!s.valid){e.push(...s.errors)}}return{valid:e.length===0,errors:e}}function U(t){const e=[];if(!t||typeof t!=="object"){e.push("Updates must be an object");return{valid:false,errors:e}}if(t.layouts){if(typeof t.layouts!=="object"){e.push("Updates.layouts must be an object")}else{if(t.layouts.desktop){const s=z(t.layouts.desktop,"desktop");if(!s.valid){e.push(...s.errors)}}if(t.layouts.mobile){const s=z(t.layouts.mobile,"mobile");if(!s.valid){e.push(...s.errors)}}}}if("zIndex"in t&&(typeof t.zIndex!=="number"||!Number.isFinite(t.zIndex))){e.push(`Updates.zIndex must be a finite number, got: ${t.zIndex}`)}if("config"in t&&typeof t.config!=="object"){e.push(`Updates.config must be an object, got: ${typeof t.config}`)}return{valid:e.length===0,errors:e}}const P=k("undo-redo");const T=50;class A{constructor(){this.commandHistory=[];this.historyPosition=-1;const{state:t,dispose:e}=j({canUndo:false,canRedo:false});this.state=t;this.dispose=e}updateButtonStates(){this.state.canUndo=this.historyPosition>=0;this.state.canRedo=this.historyPosition<this.commandHistory.length-1}push(t){P.log("âž• PUSH: Adding command to history:",t.description||t);this.commandHistory.splice(this.historyPosition+1);this.commandHistory.push(t);if(this.commandHistory.length>T){this.commandHistory.shift()}else{this.historyPosition++}P.log("  History position now:",this.historyPosition,", Total commands:",this.commandHistory.length);this.updateButtonStates()}undo(){if(this.historyPosition<0){return undefined}const t=this.commandHistory[this.historyPosition];P.log("ðŸ”™ UNDO: Executing command at position",this.historyPosition,":",t);P.log("  Command description:",t.description);const e=t.getDescription();t.undo();this.historyPosition--;P.log("  New position after undo:",this.historyPosition);this.updateButtonStates();return e}redo(){if(this.historyPosition>=this.commandHistory.length-1){return undefined}this.historyPosition++;const t=this.commandHistory[this.historyPosition];const e=t.getDescription();t.redo();this.updateButtonStates();return e}canUndo(){return this.historyPosition>=0}canRedo(){return this.historyPosition<this.commandHistory.length-1}clearHistory(){this.commandHistory.length=0;this.historyPosition=-1;this.updateButtonStates()}getUndoStackSize(){return this.historyPosition+1}getRedoStackSize(){return this.commandHistory.length-1-this.historyPosition}}const G=new A;const Z=G.state;const B=k("shared-state-registry");class H{constructor(){this.stores=new Map}getOrCreate(t,e){if(!this.stores.has(t)){B.log(`ðŸ“¦ Creating new shared store for API key: ${t}`);const{state:s,onChange:n,dispose:i}=j({canvases:(e===null||e===void 0?void 0:e.canvases)||{}});const o=new A;const r={store:{state:s,onChange:n,dispose:i},undoManager:o,refCount:0,instanceIds:new Set};this.stores.set(t,r);B.log(`âœ… Shared store created for ${t}`);return r}B.log(`â™»ï¸ Reusing existing shared store for API key: ${t}`);return this.stores.get(t)}addInstance(t,e){const s=this.stores.get(t);if(!s){console.warn(`SharedStateRegistry: Attempted to add instance ${e} to non-existent API key ${t}`);return}s.refCount++;s.instanceIds.add(e);B.log(`âž• Instance added to ${t}: ${e} (refCount: ${s.refCount})`)}removeInstance(t,e){const s=this.stores.get(t);if(!s){console.warn(`SharedStateRegistry: Attempted to remove instance ${e} from non-existent API key ${t}`);return}s.refCount--;s.instanceIds.delete(e);B.log(`âž– Instance removed from ${t}: ${e} (refCount: ${s.refCount})`);if(s.refCount<=0){B.log(`ðŸ—‘ï¸ Last instance disconnected, disposing shared store for ${t}`);this.dispose(t)}}get(t){return this.stores.get(t)}dispose(t){const e=this.stores.get(t);if(!e){return}B.log(`ðŸ—‘ï¸ Disposing shared store for ${t}`);e.store.dispose();e.undoManager.clearHistory();this.stores.delete(t);B.log(`âœ… Shared store disposed for ${t}`)}getDebugInfo(){const t={};this.stores.forEach(((e,s)=>{t[s]={refCount:e.refCount,instanceIds:Array.from(e.instanceIds),canvasCount:Object.keys(e.store.state.canvases).length,undoStackSize:e.undoManager.getUndoStackSize(),redoStackSize:e.undoManager.getRedoStackSize()}}));return t}clear(){B.log("ðŸ§¹ Clearing all shared stores");this.stores.forEach(((t,e)=>{this.dispose(e)}));this.stores.clear()}}const R=new H;const D={mobile:{minWidth:0,layoutMode:"stack"},desktop:{minWidth:768,layoutMode:"manual"}};function V(t){const e={};for(const[s,n]of Object.entries(t)){if(typeof n==="number"){e[s]={minWidth:n,layoutMode:"manual"}}else{e[s]=n}}return e}const E={canvases:{},selectedItemId:null,selectedCanvasId:null,activeCanvasId:null,currentViewport:"desktop",showGrid:true,breakpoints:D};const J=k("state-manager");class _{constructor(t,e,s){this.itemIdCounter=0;this.apiKey=null;this.instanceId=null;this.sharedStore=null;this.instanceStore=null;if(typeof t==="object"&&t!==null){s=t;t=null;e=null}this.apiKey=t||null;this.instanceId=e||`instance-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;const n=Object.assign(Object.assign({},E),s);if(this.apiKey){J.log(`Creating StateManager with split state (apiKey: ${this.apiKey}, instanceId: ${this.instanceId})`);const t=R.getOrCreate(this.apiKey,{canvases:n.canvases});this.sharedStore=t.store;R.addInstance(this.apiKey,this.instanceId);const{state:e,onChange:s,dispose:i}=j({currentViewport:n.currentViewport,selectedItemId:n.selectedItemId,selectedCanvasId:n.selectedCanvasId,activeCanvasId:n.activeCanvasId,showGrid:n.showGrid,breakpoints:n.breakpoints});this.instanceStore={state:e,onChange:s,dispose:i};this.state=this.createStateProxy();this.onChange=this.createUnifiedOnChangeHandler();const o=i;this.dispose=()=>{o();if(this.apiKey&&this.instanceId){R.removeInstance(this.apiKey,this.instanceId)}}}else{J.log(`Creating StateManager with single store (backward compatible mode)`);const{state:t,onChange:e,dispose:s}=j(n);this.state=t;this.onChange=e;this.dispose=s}this.initialState=JSON.parse(JSON.stringify(n))}createStateProxy(){if(!this.sharedStore||!this.instanceStore){throw new Error("createStateProxy called without shared/instance stores")}return new Proxy({},{get:(t,e)=>{if(e==="canvases"){return this.sharedStore.state.canvases}if(["currentViewport","selectedItemId","selectedCanvasId","activeCanvasId","showGrid","breakpoints"].includes(e)){return this.instanceStore.state[e]}return undefined},set:(t,e,s)=>{if(e==="canvases"){this.sharedStore.state.canvases=s;return true}if(["currentViewport","selectedItemId","selectedCanvasId","activeCanvasId","showGrid","breakpoints"].includes(e)){this.instanceStore.state[e]=s;return true}return false}})}createUnifiedOnChangeHandler(){if(!this.sharedStore||!this.instanceStore){throw new Error("createUnifiedOnChangeHandler called without shared/instance stores")}return(t,e)=>{if(t==="canvases"){return this.sharedStore.onChange(t,e)}if(["currentViewport","selectedItemId","selectedCanvasId","activeCanvasId","showGrid","breakpoints"].includes(t)){return this.instanceStore.onChange(t,e)}return()=>{}}}reset(){this.itemIdCounter=0;this.state.canvases=JSON.parse(JSON.stringify(this.initialState.canvases));this.state.selectedItemId=this.initialState.selectedItemId;this.state.selectedCanvasId=this.initialState.selectedCanvasId;this.state.activeCanvasId=this.initialState.activeCanvasId;this.state.currentViewport=this.initialState.currentViewport;this.state.showGrid=this.initialState.showGrid}addItemToCanvas(t,e){const s=this.state.canvases[t];if(!s){return}const n=N(e);if(!n.valid){J.warn("âš ï¸ [addItemToCanvas] with validation issues:",{itemId:e.id,canvasId:t,errors:n.errors})}s.items.push(e);this.state.canvases=Object.assign({},this.state.canvases)}removeItemFromCanvas(t,e){const s=this.state.canvases[t];if(!s){return}s.items=s.items.filter((t=>t.id!==e));this.state.canvases=Object.assign({},this.state.canvases)}updateItem(t,e,s){const n=this.state.canvases[t];if(!n){return}const i=n.items.find((t=>t.id===e));if(!i){return}const o=U(s);if(!o.valid){J.warn("âš ï¸ [updateItem] with validation issues:",{itemId:e,canvasId:t,updates:s,errors:o.errors})}Object.assign(i,s);this.state.canvases=Object.assign({},this.state.canvases)}getItem(t,e){const s=this.state.canvases[t];if(!s){return null}return s.items.find((t=>t.id===e))||null}moveItemToCanvas(t,e,s){const n=this.state.canvases[t];const i=this.state.canvases[e];if(!n||!i){return}const o=n.items.find((t=>t.id===s));if(!o){return}const r=N(o);if(!r.valid){J.warn("âš ï¸ [moveItemToCanvas] with validation issues:",{itemId:s,fromCanvasId:t,toCanvasId:e,errors:r.errors})}n.items=n.items.filter((t=>t.id!==s));o.canvasId=e;i.items.push(o);this.state.canvases=Object.assign({},this.state.canvases)}generateItemId(){return`item-${++this.itemIdCounter}`}setItemZIndex(t,e,s){const n=this.state.canvases[t];if(!n){return null}const i=n.items.find((t=>t.id===e));if(!i){return null}const o=i.zIndex;i.zIndex=s;if(s>=n.zIndexCounter){n.zIndexCounter=s+1}this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:o,newZIndex:s}}moveItemForward(t,e){const s=this.state.canvases[t];if(!s){return null}const n=s.items.find((t=>t.id===e));if(!n){return null}const i=[...s.items].sort(((t,e)=>t.zIndex-e.zIndex));const o=i.findIndex((t=>t.id===e));if(o===i.length-1){return null}const r=i[o+1];const c=n.zIndex;const a=r.zIndex;n.zIndex=a;r.zIndex=c;this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:c,newZIndex:a}}moveItemBackward(t,e){const s=this.state.canvases[t];if(!s){return null}const n=s.items.find((t=>t.id===e));if(!n){return null}const i=[...s.items].sort(((t,e)=>t.zIndex-e.zIndex));const o=i.findIndex((t=>t.id===e));if(o===0){return null}const r=i[o-1];const c=n.zIndex;const a=r.zIndex;n.zIndex=a;r.zIndex=c;this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:c,newZIndex:a}}bringItemToFront(t,e){const s=this.state.canvases[t];if(!s){return null}const n=s.items.find((t=>t.id===e));if(!n){return null}const i=n.zIndex;const o=Math.max(...s.items.map((t=>t.zIndex)));if(i===o){return null}const r=s.zIndexCounter++;n.zIndex=r;this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:i,newZIndex:r}}sendItemToBack(t,e){const s=this.state.canvases[t];if(!s){return null}const n=s.items.find((t=>t.id===e));if(!n){return null}const i=n.zIndex;const o=Math.min(...s.items.map((t=>t.zIndex)));if(i===o){return null}const r=o-1;n.zIndex=r;this.state.canvases=Object.assign({},this.state.canvases);return{oldZIndex:i,newZIndex:r}}selectItem(t,e){this.state.selectedItemId=t;this.state.selectedCanvasId=e}deselectItem(){this.state.selectedItemId=null;this.state.selectedCanvasId=null}setActiveCanvas(t){this.state.activeCanvasId=t}clearActiveCanvas(){this.state.activeCanvasId=null}addItemsBatch(t){const e=[];const s=Object.assign({},this.state.canvases);for(const n of t){const t=this.generateItemId();const i=n.canvasId;const o=s[i];if(!o){console.warn(`Canvas ${i} not found, skipping item`);continue}const r={id:t,canvasId:i,type:n.type||"unknown",name:n.name||"Unnamed",layouts:n.layouts||{desktop:{x:0,y:0,width:20,height:10,customized:true},mobile:{x:null,y:null,width:null,height:null,customized:false}},zIndex:o.zIndexCounter++,config:n.config||{}};const c=N(r);if(!c.valid){J.warn("âš ï¸ [addItemsBatch] with validation issues:",{itemId:t,canvasId:i,errors:c.errors})}o.items.push(r);e.push(t)}this.state.canvases=s;return e}deleteItemsBatch(t){const e=new Set(t);const s=Object.assign({},this.state.canvases);for(const t in s){s[t]=Object.assign(Object.assign({},s[t]),{items:s[t].items.filter((t=>!e.has(t.id)))})}this.state.canvases=s}updateItemsBatch(t){const e=Object.assign({},this.state.canvases);for(const{itemId:s,canvasId:n,updates:i}of t){const t=e[n];if(!t){console.warn(`Canvas ${n} not found, skipping item ${s}`);continue}const o=t.items.find((t=>t.id===s));if(!o){console.warn(`Item ${s} not found in canvas ${n}`);continue}Object.assign(o,i)}this.state.canvases=e}}const F=new _;const W=F.state;const K=()=>F.generateItemId();const L=(t,e)=>F.selectItem(t,e);const X=t=>F.setActiveCanvas(t);export{D,_ as S,A as U,f as a,h as b,a as c,u as d,l as e,k as f,W as g,L as h,d as i,p as j,R as k,s as l,K as m,V as n,j as o,m as p,v as q,X as s,Z as u};
//# sourceMappingURL=p-BiM0xz1T.js.map