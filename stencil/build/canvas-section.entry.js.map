{"file":"canvas-section.entry.esm.js","mappings":"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","names":["gridState","interact"],"sources":["src/components/canvas-section/canvas-section.css?tag=canvas-section","src/components/canvas-section/canvas-section.tsx"],"sourcesContent":["/* Canvas Section */\n.canvas-item {\n  position: relative;\n  display: flex;\n  width: 100%;\n  flex-direction: column;\n}\n\n.canvas-item-header {\n  position: absolute;\n  z-index: 1000;\n  top: 10px;\n  right: 10px;\n  display: flex;\n  align-items: center;\n  padding: 8px 12px;\n  border-radius: 4px;\n  background: rgba(255, 255, 255, 95%);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 10%);\n  color: #666;\n  font-size: 12px;\n  gap: 10px;\n  opacity: 0.7;\n  transition: opacity 0.2s;\n}\n\n.canvas-item:hover .canvas-item-header {\n  opacity: 1;\n}\n\n.canvas-item-header h3 {\n  margin: 0;\n  color: #999;\n  font-size: 11px;\n  letter-spacing: 0.5px;\n  text-transform: uppercase;\n}\n\n.canvas-controls {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.canvas-controls label {\n  display: flex;\n  align-items: center;\n  color: #999;\n  cursor: pointer;\n  font-size: 11px;\n  gap: 4px;\n}\n\n.canvas-bg-color {\n  width: 30px;\n  height: 24px;\n  border: 1px solid #ddd;\n  border-radius: 3px;\n  cursor: pointer;\n}\n\n.clear-canvas-btn,\n.delete-section-btn {\n  padding: 4px 10px;\n  border: 1px solid #ddd;\n  border-radius: 3px;\n  background: white;\n  color: #666;\n  cursor: pointer;\n  font-size: 11px;\n  transition: all 0.2s;\n}\n\n.clear-canvas-btn:hover {\n  border-color: #4a90e2;\n  background: #f5f5f5;\n  color: #4a90e2;\n}\n\n.delete-section-btn {\n  padding: 4px 8px;\n}\n\n.delete-section-btn:hover {\n  border-color: #dc3545;\n  background: #fee;\n}\n\n/* Grid Builder Container */\n.grid-builder {\n  width: 100%;\n  padding: 0;\n  border-radius: 0;\n  margin-bottom: 0;\n  background: transparent;\n}\n\n/* Grid Container */\n.grid-container {\n  position: relative;\n  width: 100%;\n  min-height: 400px;\n  background-image: linear-gradient(rgba(0, 0, 0, 5%) 1px, transparent 1px),\n    linear-gradient(90deg, rgba(0, 0, 0, 5%) 1px, transparent 1px);\n  background-size: 2% 20px;\n  transition: background-color 0.2s;\n}\n\n.grid-container.hide-grid {\n  background-image: none;\n}\n","import { Component, h, Prop, State } from '@stencil/core';\n// Use the standard interactjs package import\nimport interact from 'interactjs';\nimport { Canvas, GridItem, gridState, onChange } from '../../services/state-manager';\nimport { clearGridSizeCache, gridToPixelsX, gridToPixelsY } from '../../utils/grid-calculations';\n\n@Component({\n  tag: 'canvas-section',\n  styleUrl: 'canvas-section.css',\n  shadow: false, // Use light DOM for compatibility with interact.js\n})\nexport class CanvasSection {\n  @Prop() canvasId!: string;\n  @Prop() sectionNumber!: number;\n\n  @State() canvas: Canvas;\n  @State() renderVersion: number = 0; // Force re-render when this changes\n\n  private gridContainerRef: HTMLElement;\n  private dropzoneInitialized: boolean = false;\n  private resizeObserver: ResizeObserver;\n\n  componentWillLoad() {\n    // Initial load\n    this.canvas = gridState.canvases[this.canvasId];\n\n    // Subscribe to state changes\n    onChange('canvases', () => {\n      // Guard against accessing properties when component is not fully initialized\n      try {\n        if (this.canvasId && gridState.canvases[this.canvasId]) {\n          this.canvas = gridState.canvases[this.canvasId];\n          this.renderVersion++; // Force re-render\n        }\n      } catch (_e) {\n        // Component may not be fully initialized yet (e.g., during test setup)\n      }\n    });\n  }\n\n  componentWillUpdate() {\n    // Update canvas reference when state changes\n    this.canvas = gridState.canvases[this.canvasId];\n  }\n\n  componentDidLoad() {\n    this.initializeDropzone();\n    this.setupResizeObserver();\n  }\n\n  disconnectedCallback() {\n    // Cleanup interact.js\n    if (this.gridContainerRef && this.dropzoneInitialized) {\n      interact(this.gridContainerRef).unset();\n    }\n\n    // Cleanup ResizeObserver\n    if (this.resizeObserver) {\n      this.resizeObserver.disconnect();\n    }\n  }\n\n  private setupResizeObserver() {\n    if (!this.gridContainerRef) {\n      return;\n    }\n\n    // Watch for canvas container size changes\n    this.resizeObserver = new ResizeObserver(() => {\n      // Clear grid size cache when container resizes\n      clearGridSizeCache();\n\n      // Force re-render to update item positions\n      this.renderVersion++;\n    });\n\n    this.resizeObserver.observe(this.gridContainerRef);\n  }\n\n  render() {\n    const showGrid = gridState.showGrid;\n    const backgroundColor = this.canvas?.backgroundColor || '#ffffff';\n\n    return (\n      <div class=\"canvas-item\" data-canvas-id={this.canvasId}>\n        <div class=\"canvas-item-header\">\n          <h3>Section {this.sectionNumber}</h3>\n          <div class=\"canvas-controls\">\n            <label>\n              <input\n                type=\"color\"\n                class=\"canvas-bg-color\"\n                value={backgroundColor}\n                onInput={(e) => this.handleColorChange(e)}\n              />\n            </label>\n            <button class=\"clear-canvas-btn\" onClick={() => this.handleClearCanvas()}>\n              Clear\n            </button>\n            <button class=\"delete-section-btn\" onClick={() => this.handleDeleteSection()} title=\"Delete Section\">\n              üóëÔ∏è\n            </button>\n          </div>\n        </div>\n        <div class=\"grid-builder\">\n          <div\n            class={{\n              'grid-container': true,\n              'hide-grid': !showGrid,\n            }}\n            id={this.canvasId}\n            data-canvas-id={this.canvasId}\n            style={{\n              backgroundColor,\n            }}\n            ref={(el) => (this.gridContainerRef = el)}\n          >\n            {/* Grid items will be rendered here by grid-item-wrapper components */}\n            {this.canvas?.items.map((item: GridItem) => (\n              <grid-item-wrapper key={item.id} item={item} renderVersion={this.renderVersion} />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  private initializeDropzone() {\n    if (!this.gridContainerRef || this.dropzoneInitialized) {\n      return;\n    }\n\n    const interactable = interact(this.gridContainerRef);\n\n    interactable.dropzone({\n      accept: '.palette-item, .grid-item', // Accept both palette items and grid items\n      overlap: 'pointer', // Use pointer position instead of element overlap\n\n      checker: (_dragEvent: any, _event: any, dropped: boolean) => {\n        return dropped;\n      },\n\n      ondrop: (event: any) => {\n        const droppedElement = event.relatedTarget;\n        const isPaletteItem = droppedElement.classList.contains('palette-item');\n        const isGridItem = droppedElement.classList.contains('grid-item');\n\n        if (isPaletteItem) {\n          // Dropping from palette - create new item\n          const componentType = droppedElement.getAttribute('data-component-type');\n\n          // Calculate half dimensions for centering (default: 10 units wide, 6 units tall)\n          const defaultWidth = 10;\n          const defaultHeight = 6;\n          const widthPx = gridToPixelsX(defaultWidth, this.canvasId);\n          const heightPx = gridToPixelsY(defaultHeight);\n          const halfWidth = widthPx / 2;\n          const halfHeight = heightPx / 2;\n\n          // Get drop position relative to grid container\n          const rect = this.gridContainerRef.getBoundingClientRect();\n          const x = event.dragEvent.clientX - rect.left - halfWidth;\n          const y = event.dragEvent.clientY - rect.top - halfHeight;\n\n          // Dispatch custom event for grid-builder-app to handle\n          const dropEvent = new CustomEvent('canvas-drop', {\n            detail: {\n              canvasId: this.canvasId,\n              componentType,\n              x,\n              y,\n            },\n            bubbles: true,\n            composed: true,\n          });\n          this.gridContainerRef.dispatchEvent(dropEvent);\n        } else if (isGridItem) {\n          // Moving existing grid item to different canvas\n          const itemId = droppedElement.id;\n          const sourceCanvasId = droppedElement.getAttribute('data-canvas-id');\n\n          // Only process if moving to a different canvas\n          if (sourceCanvasId !== this.canvasId) {\n            // For cross-canvas moves, get the element's actual screen position\n            // (the drag handler has already positioned it during the drag)\n            const droppedRect = droppedElement.getBoundingClientRect();\n            const rect = this.gridContainerRef.getBoundingClientRect();\n\n            // Use the element's top-left corner relative to the target canvas\n            const x = droppedRect.left - rect.left;\n            const y = droppedRect.top - rect.top;\n\n            // Dispatch custom event for moving item between canvases\n            const moveEvent = new CustomEvent('canvas-move', {\n              detail: {\n                itemId,\n                sourceCanvasId,\n                targetCanvasId: this.canvasId,\n                x,\n                y,\n              },\n              bubbles: true,\n              composed: true,\n            });\n            this.gridContainerRef.dispatchEvent(moveEvent);\n          }\n        }\n      },\n    });\n\n    this.dropzoneInitialized = true;\n  }\n\n  private handleColorChange(e: Event) {\n    const target = e.target as HTMLInputElement;\n    const color = target.value;\n\n    // Update state\n    this.canvas.backgroundColor = color;\n    gridState.canvases = { ...gridState.canvases }; // Trigger update\n\n    // Also update DOM directly for immediate feedback\n    if (this.gridContainerRef) {\n      this.gridContainerRef.style.backgroundColor = color;\n    }\n  }\n\n  private handleClearCanvas() {\n    if (confirm(`Are you sure you want to clear all items from this section?`)) {\n      // Clear items from state\n      this.canvas.items = [];\n      gridState.canvases = { ...gridState.canvases }; // Trigger update\n\n      // Clear selection if on this canvas\n      if (gridState.selectedCanvasId === this.canvasId) {\n        gridState.selectedItemId = null;\n        gridState.selectedCanvasId = null;\n      }\n\n      // Reset canvas height\n      if (this.gridContainerRef) {\n        this.gridContainerRef.style.minHeight = '400px';\n      }\n    }\n  }\n\n  private handleDeleteSection() {\n    if (this.canvas.items.length > 0) {\n      if (!confirm(`This section has ${this.canvas.items.length} items. Are you sure you want to delete it?`)) {\n        return;\n      }\n    }\n\n    // Dispatch custom event for grid-builder-app to handle\n    const deleteEvent = new CustomEvent('section-delete', {\n      detail: { canvasId: this.canvasId },\n      bubbles: true,\n      composed: true,\n    });\n    this.gridContainerRef.dispatchEvent(deleteEvent);\n  }\n}\n"],"version":3}